# Challenge Name : `symmetric`

- **Category:** Cryptography
- **Points:** 50  
- **Author:** epistemologist

---

##  Description

> I'm using four primes to encrypt my flag, so I'm only giving you three hints - can you decrypt the flag?

<p align="center"><img width="640" height="360" alt="image" src="https://github.com/user-attachments/assets/19b3060b-14a1-41c9-9d53-cc9edc3fd055" /></p>


---

## Files Provided

- A python code : `chal.py`

The relevant code -
```python
p, q, r, s = [getPrime(512) for _ in "1234"]

print(f"h1 = {p + q + r + s}")
print(f"h2 = {p**2 + q**2 + r**2 + s**2}")
print(f"h3 = {p**3 + q**3 + r**3 + s**3}")

N = p*q*r*s
print(f"N = {N}")
pt = bytes_to_long(FLAG)
ct = pow(pt, 65537, N)
print(f"ct = {ct}")
```
- A text file : `output.txt`

```
h1 = 44626154099651354925697068610752642661842459492769931945027538340211738148995902544351457443643808803963130274930824732652561687395268828472477422919262224
h2 = 516671113554555861164166966331322883848052630063409185414998284127910160310316421085219788291486248715029393774584960034375836715001130337767354512063372620828300201147366138270597133744747341658011663632381219284289144790858167258162656417236910634201286428763727072739569460623482985066956478781223378673732
h3 = 6147718474663450187001867904227777991349731066494841442199681943204194617136760567222545181562592364728655444222576167723225771866335920325045525027985716792468801076590684892140052786942251780392395274059384743594570343510311801194684613435002073956759521242578078411431891501758484581445964234548107005826532945720412531638919892681259687552977883437895032963223761216846303917338652743754915155934118353066174102436448393348040719582422022713292561416343278608
N = 14184841414933523698606245433393907034474143715949896731683874356940146602876788990832087413915033843120975580859113356518777762025417525571528638829956003882418585702756644491932279294535883798799580861254646149745925137179207140600356428758736111639677698862407787386573263961111978517446397007747429416079059195916290615125084899002162504424765939524455434579218079962808920072946861658695379491917567048202142417165204141307476222251547098848515065051745905180788313450494477967398727631152936238366581978379130450660235139256967936160718128731512409111209840405772933034600016694225294481603355934917366484109057
ct = 720607330561370237459911161481490697044029472780348552630924063963226757984368356580217337982783395620115957442082471977614781910209933696251479615689667675958354681196823652299435457532944189300223816303315625302472302494905575910600277892375951366031061219173465155686586206246661009612156094695841741309002508535764511343569015518587247600796520847856011377777228749182958947015029731456117404560626347774985507275302882865400315045173501559082431672490227728580592379740508214726249635835834752208899970446910850569489282065524329936561486377823093465841715608716032843259935185417766702677708267102415636848129

```
---

## What Do We Get From This

The implementation is that of a typical RSA, except that the key is the product of 4 primes instead of 2. If you are not sure about how to deal with more than 2 prime factors, check out my writeup for [too many primes](https://github.com/libbabel-so/Writeups/blob/main/UIUCTF/crypto/toomanyprimes.md).

The leak is said to be only 3 relations (`h1`, `h2`, `h3`) of the primes involved (`p`, `q`, `r`, `s`) as follows.
- `h1 = p + q + r + s`
- `h2 = p^2 + q^2 + r^2 + s^2`
- `h3 = p^3 + q^3 + r^3 + s^3`

--- 

## The Maths

The idea behind this leak is to make you feel that there are insufficient equations to actually equate the individual values of the primes. This arises from the basic rule that you need as many equations as the number of unknowns you have to solve for exact values. (This is just stating it simply, I will not go into the matrix theory behind this)

This would have been impossible (or atleast very very hard) to solve if we indeed had only three relations, but there is one extra equation that may be overlooked but is hidden in plain sight!

`n = p * q * r * s`

Using our basic polynomial knowledge, if I were to make a quartic polynomial with `p`, `q`, `r` and `s` as roots, it would be of the form

`f(x) = x^4 - b*x^3 + c*x^2 - d*x + e`

where - 
- `b` = sum of roots
- `c` = sum of roots taken 2 at a time
- `d` = sum of roots taken 3 at a time
- `e` = sum of roots taken 4 at a time (product of roots)

And since we have 4 relations using the roots, we can define the needed value as follows - 
- `b = h1`
- `c = (h1^2 - h2)/2`
- `d = (h1^3 - 3*h1*h2 + 2*h3)/6`
- `e = n`

(If you're new to this, grab a pen and paper and try to get these relations yourself as an exercise)

Forming this polynomial and finding its roots using any tool (I used the `sympy` module in Python) leads us to our required primes.

---

## Code

```python
from Crypto.Util.number import *
from sympy import Poly,symbols,solve

ct = 720607330561370237459911161481490697044029472780348552630924063963226757984368356580217337982783395620115957442082471977614781910209933696251479615689667675958354681196823652299435457532944189300223816303315625302472302494905575910600277892375951366031061219173465155686586206246661009612156094695841741309002508535764511343569015518587247600796520847856011377777228749182958947015029731456117404560626347774985507275302882865400315045173501559082431672490227728580592379740508214726249635835834752208899970446910850569489282065524329936561486377823093465841715608716032843259935185417766702677708267102415636848129
n = 14184841414933523698606245433393907034474143715949896731683874356940146602876788990832087413915033843120975580859113356518777762025417525571528638829956003882418585702756644491932279294535883798799580861254646149745925137179207140600356428758736111639677698862407787386573263961111978517446397007747429416079059195916290615125084899002162504424765939524455434579218079962808920072946861658695379491917567048202142417165204141307476222251547098848515065051745905180788313450494477967398727631152936238366581978379130450660235139256967936160718128731512409111209840405772933034600016694225294481603355934917366484109057
h1 = 44626154099651354925697068610752642661842459492769931945027538340211738148995902544351457443643808803963130274930824732652561687395268828472477422919262224
h2 = 516671113554555861164166966331322883848052630063409185414998284127910160310316421085219788291486248715029393774584960034375836715001130337767354512063372620828300201147366138270597133744747341658011663632381219284289144790858167258162656417236910634201286428763727072739569460623482985066956478781223378673732
h3 = 6147718474663450187001867904227777991349731066494841442199681943204194617136760567222545181562592364728655444222576167723225771866335920325045525027985716792468801076590684892140052786942251780392395274059384743594570343510311801194684613435002073956759521242578078411431891501758484581445964234548107005826532945720412531638919892681259687552977883437895032963223761216846303917338652743754915155934118353066174102436448393348040719582422022713292561416343278608

# Calculate coefficients
p1 = h1
p2 = (h1**2-h2)//2
p3 = (h1**3-3*h1*h2+2*h3)//6
p4 = n

# Form and solve polynomial
x = symbols('x')
f = Poly(x**4-p1*x**3+p2*x**2-p3*x+p4,x)

primes = solve(f)   # List of the prime factors

# Decrypt the RSA ciphertext
phi = 1
for i in primes:
    phi*=int(i-1)
    
d = pow(65537,-1,phi)
print("Flag -",long_to_bytes(pow(ct,d,n)).decode())

```

---

## Result

```
Flag - uiuctf{5yMmeTRiC_P0lyS_FoRM_A_B4S15}
```


---

<p align="center"> <img width="655" height="494" alt="{34D26BE3-AD9E-4F9E-B613-834BFAA4C4D8}" src="https://github.com/user-attachments/assets/f267a024-97ed-4e66-9942-9bc5c100c7e3" /> </p>


